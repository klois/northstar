<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Northstar</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="client/client.html"><strong aria-hidden="true">1.</strong> Implementing a client</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="client/connect.html"><strong aria-hidden="true">1.1.</strong> Interacting with Northstar</a></li><li class="chapter-item expanded "><a href="client/repositories.html"><strong aria-hidden="true">1.2.</strong> Repositories</a></li><li class="chapter-item expanded "><a href="client/containers.html"><strong aria-hidden="true">1.3.</strong> Containers</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="client/list_containers.html"><strong aria-hidden="true">1.3.1.</strong> List containers</a></li><li class="chapter-item expanded "><a href="client/start_containers.html"><strong aria-hidden="true">1.3.2.</strong> Starting containers and notifications</a></li><li class="chapter-item expanded "><a href="client/stop_containers.html"><strong aria-hidden="true">1.3.3.</strong> Stopping containers</a></li><li class="chapter-item expanded "><a href="client/install_containers.html"><strong aria-hidden="true">1.3.4.</strong> Installing and uninstalling containers</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Northstar</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="implementing-a-client"><a class="header" href="#implementing-a-client">Implementing a client</a></h1>
<p>This tutorial demonstrates how to interact with <strong>Northstar</strong> using its <strong>API</strong>.</p>
<p><strong>Northstar</strong> uses <strong>JSON</strong> to encode the messages shared with clients. This is
a common approach that facilitates clients being implemented in any programming
language.  However, <strong>Northstar</strong> as a library, provides a convenient <code>Client</code>
type that can be used for a simpler client implementation using <strong>Rust</strong>.</p>
<p>For general purposes, the snippets shown in this tutorial are
written in <strong>Python</strong> for its simplicity and easy translation to other
languages.</p>
<h1 id="interation-with-northstar"><a class="header" href="#interation-with-northstar">Interation with Northstar</a></h1>
<p>Northstar interacts with clients through a <code>TCP</code> socket. The clients exchange
messages with Northstar in the form of requests and responses encoded in
<strong>JSON</strong>. These requests and responses are a direct serialization of the
structures defined in <code>api/model.rs</code>.</p>
<p>The first step is to establish a connection with Northstar using a socket.</p>
<pre><code class="language-python">import socket

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((&quot;localhost&quot;, 4200))
</code></pre>
<p>Northstar uses the port <code>4200</code> by default. Check the configuration (see
<code>northstar.toml</code>) for the port used by the target instance.</p>
<p>The messages sent between Northstar and the clients have two fields, <code>id</code> and
<code>payload</code>.  The <code>id</code> field is a generated <code>UUID</code> version 4 identifier used to
tag a message exchange.</p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;UUID&quot;,
    &quot;payload&quot;: {
        MESSAGE_TYPE: { ... }
    }
}
</code></pre>
<p>The <code>MESSAGE_TYPE</code> can be either <code>&quot;Request&quot;</code>, <code>&quot;Response&quot;</code>, or <code>&quot;Notification&quot;</code>.
Northstar should only send responses and notifications to clients.</p>
<h1 id="northstar-repositories"><a class="header" href="#northstar-repositories">Northstar Repositories</a></h1>
<p>Repositories are used to group sets of containers. These are specified in
the Northstar configuration (see <code>northstar.toml</code>).</p>
<p>Containers can be added or removed from repositories at runtime by
<strong>installing</strong> and <strong>uninstalling</strong> them.</p>
<p>Repositories specified in the configuration are accessed at the start of
Northstar. Currently it is not possible to add or remove repositories at
runtime.</p>
<p>If a repository specifies a signing key in the configuration, the contents of the
containers are checked with their signature information. Otherwise, this step is
skipped. Notice that for the verification step, it is required that the
underlying system has <code>verity</code> support enabled. Containers installed at runtime
to repositories with a signing key will also be verified.</p>
<p>The next block shows the <code>JSON</code> structure that represents the request for the
repository configuration. It is important to encode this structure without the
new lines. Also a new line has to be appended to the end of the serialized
string.</p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&quot;,
    &quot;payload&quot;: {
        &quot;Request&quot;: &quot;Repositories&quot;
    }
}
</code></pre>
<p>Here is an example that sends a request for the repository configuration:</p>
<pre><code class="language-python">import uuid
import json

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((&quot;localhost&quot;, 4200))

# API Request for repository information
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': 'Repositories'
    }
}

# It is required for the API requests to be terminated with a new line '\n'
request = json.dumps(request) + '\n'

# send the request
s.send(request.encode('utf-8'))

# receive the list of repositories
response = s.recv(8000)

# decode the response
response = json.loads(response.decode('utf-8'))

# The response contains a list with the configured repositories
# Currently, only the filesystem path of every repository is provided
# e.g. {'Response': {'Repositories': {'default': {'dir': 'target/northstar/repository'}}}}
print(response['payload'])
</code></pre>
<h1 id="containers"><a class="header" href="#containers">Containers</a></h1>
<ul>
<li><a href="client/list_containers.html">List containers</a></li>
<li><a href="client/start_containers.html">Starting containers and notifications</a></li>
<li><a href="client/stop_containers.html">Stopping containers</a></li>
<li><a href="client/install_containers.html">Installing and uninstalling containers</a></li>
</ul>
<h1 id="listing-containers"><a class="header" href="#listing-containers">Listing containers</a></h1>
<p>In the same way as <a href="client/repositories.html">repositories</a>, it is possible to request
the current state of the Northstar containers. Here is the <code>JSON</code> structure that
encodes the request for the state of the containers:</p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&quot;,
    &quot;payload&quot;: {
        &quot;Request&quot;: &quot;Containers&quot;
    }
}
</code></pre>
<p>The following snippet sends the request for the container information, just as
the previous example requested the repository configuration.</p>
<pre><code class="language-python"># The request looks like this:
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': 'Containers'
    }
}

# notice the terminating '\n'
request = json.dumps(request) + '\n'

# send request
s.send(request.encode('utf-8'))

# receive the list of containers
response = s.recv(8000)

# Decode the JSON response
response = json.loads(response.decode('utf-8'))

# The response is a list of containers.
# Each of these containers will come with the following fields:
#   - manifest
#   - process
#   - repository
print(response)
</code></pre>
<p>The response is quite lengthy and more complex than that of repositories. This
time, we receive a list of objects corresponding to each container. Each
of them provides information about the container's manifest, the repository
where it is installed and possibly information about the system process if it is
currently executing.</p>
<p>Here is an example on how to get a list with names of the available containers:</p>
<pre><code class="language-python">names = []
for container in response['payload']['Response']['Containers']:
    names.append(container['manifest']['name'])

# e.g. containers: ['cpueater', 'ferris_says_hello', 'seccomp', 'memeater', ...
print(f'containers: {names}')
</code></pre>
<h1 id="starting-containers-and-notifications"><a class="header" href="#starting-containers-and-notifications">Starting containers and notifications</a></h1>
<p>Northstar has a notification system where messages are sent to the clients with
information about events such as:</p>
<ul>
<li>Applications starting</li>
<li>Applications stopping</li>
<li>Applications installed</li>
<li>Applications uninstalled</li>
<li>Exit status of applications</li>
<li>Shutdown of the runtime</li>
<li>Applications running out of memory</li>
</ul>
<p>Here is the <code>JSON</code> structure requesting that Northstar start a container.
<code>CONTAINER_NAME</code> is the name of the container specified in the manifest that will be started.</p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&quot;,
    &quot;payload&quot;: {
        &quot;Request&quot;: {
            &quot;Start&quot;: CONTAINER_NAME
        }
    }
}
</code></pre>
<p>In the following snippet, a request is sent to start the <code>memeater</code> example
container. After the container is started, we will receive 2 notifications, one signaling the start of the application, and eventually a second one that signals
the termination of the application (after consuming all the memory, as this example is designed to do).</p>
<pre><code class="language-python"># start memeater container
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': {
            'Start': &quot;memeater&quot;
        }
    }
}

# Serialize the request, notice the appended new line
request = json.dumps(request) + '\n'

# Encode and send the request
s.send(request.encode('utf-8'))

# Receive the ok response to the request
# {'Response': {'Ok': None}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))

# Receive the first notification for the start of the container
# {'Notification': {'ApplicationStarted': ['memeater', '0.0.1']}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))

# Receive the notification for the out of memory
# {'Notification': {'OutOfMemory': 'memeater'}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))
</code></pre>
<h1 id="stopping-containers"><a class="header" href="#stopping-containers">Stopping containers</a></h1>
<p>Analogous to <a href="client/start_containers.html">starting containers</a>, this is the <code>JSON</code>
structure to stop a container:</p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&quot;,
    &quot;payload&quot;: {
        &quot;Request&quot;: {
            &quot;Stop&quot;: CONTAINER_NAME
        }
    }
}
</code></pre>
<p>Stopping containers is very similar to starting them. In the following snippet
we start and subsequently stop the <code>hello</code> example container.</p>
<pre><code class="language-python"># Start hello container
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': {
            'Start': &quot;hello&quot;
        }
    }
}

# Send the request
request = json.dumps(request) + '\n'
s.send(request.encode('utf-8'))

# get ok response
# {'Response': {'Ok': None}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))

# get application started notification
# {'Notification': {'ApplicationStarted': ['hello', '0.0.1']}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))

# Stop hello container
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': {
            'Stop': &quot;hello&quot;
        }
    }
}

# Send the request
request = json.dumps(request) + '\n'
s.send(request.encode('utf-8'))

# Get ok response
# {'Response': {'Ok': None}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))

# Get notification for the stopped container
# {'Notification': {'ApplicationStopped': ['hello', '0.0.1']}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))
</code></pre>
<h1 id="installing-and-uninstalling-containers"><a class="header" href="#installing-and-uninstalling-containers">Installing and uninstalling containers</a></h1>
<p>Installing containers is a bit trickier. First a request to install a new
container is sent with the target repository and the size of the container <code>npk</code>
file in bytes. Then the file is directly copied into the socket. If successful,
an <code>Ok</code> response will be received with a notification of the newly installed
container. The following is the <code>JSON</code> structure to signal the installation of a
new container:</p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&quot;,
    &quot;payload&quot;: {
        &quot;Request&quot;: {
            &quot;Install&quot;: [REPOSITORY_NAME, NPK_SIZE]
        }
    }
}
</code></pre>
<p>The <code>REPOSITORY_NAME</code> is the identifier of the target repository where to
install the new container (see <a href="client/repositories.html">repositories</a>). <code>NPK_SIZE</code> is
the size in bytes of the <code>.npk</code> file that will be transfered. The request for
uninstalling a container requires the name and version of the container
specified in <code>CONTAINER_NAME</code> and <code>CONTAINER_VERSION</code> correspondingly.</p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX&quot;,
    &quot;payload&quot;: {
        &quot;Request&quot;: {
            &quot;Uninstall&quot;: [CONTAINER_NAME, CONTAINER_VERSION]
        }
    }
}
</code></pre>
<p>For the following snippet, we can create a dummy container called <code>foo</code>. First,
we create a directory layout for he container that looks like this:</p>
<pre><code>foo
├── manifest.yaml
└── root
    └── foo
</code></pre>
<p>The file <code>foo</code> inside the <code>root</code> is just a &quot;hello world&quot; binary compiled for the
host architecture but any other file works for this example. The content for the
<code>manifest.yaml</code> is the following:</p>
<pre><code class="language-yaml">name: foo
version: 0.0.1
init: /foo
mounts:
    /lib:
        host: /lib
    /lib64:
        host: /lib64
</code></pre>
<p>Finally, we use <code>sextant</code> to pack the container into a <code>npk</code> file.</p>
<pre><code class="language-sh">sextant pack --dir foo --out . --key examples/keys/northstar.key
</code></pre>
<p>This will produce a file named <code>foo-0.0.1.npk</code> in the current directory. Now we
can install and uninstall the container in Northstar as follows:</p>
<pre><code class="language-python">import os

npk = &quot;foo-0.0.1.npk&quot;
npk_size = os.path.getsize(npk)

# Request to install the container in the &quot;default&quot; repository
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': {
            'Install': [&quot;default&quot;, npk_size]
        }
    }
}

# Serialize
request = json.dumps(request) + '\n'

# Send the request
s.send(request.encode('utf-8'))

# Now we simply copy the file to the socket
with open(npk, 'rb') as f:
    chunk = f.read(4096)
    while chunk:
        s.send(chunk)
        chunk = f.read(4096)

# Receive an ok response
# {'Response': {'Ok': None}}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))

# Get application installed notification
# {'Notification': {'Install': ['foo', '0.0.1']}}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))

# Uninstall the container
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': {
            'Uninstall': [&quot;foo&quot;, &quot;0.0.1&quot;]
        }
    }
}

# send the request
request = json.dumps(request) + '\n'
s.send(request.encode('utf-8'))

# Receive an ok response
# {'Response': {'Ok': None}}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))

# Get application uninstalled notification
# {'Notification': {'Uninstalled': ['foo', '0.0.1']}}}
response = s.recv(8000)
print(json.loads(response.decode('utf-8')))
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
